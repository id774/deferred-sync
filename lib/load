#!/bin/sh
#
# load - A script to dynamically load plugins for deferred-sync.
#
# Description:
#   This script loads the required plugins based on configuration settings.
#   It supports:
#     - Loading specific plugins defined in `PLUGINS`
#     - Loading all available plugins if `LOAD_PLUGINS_ALL=true`
#
# Behavior:
#   - Each plugin is sourced from `$SCRIPT_HOME/lib/plugins/`
#   - If a plugin returns a non-zero status, a [WARN] message is printed,
#     but subsequent plugins continue to execute.
#   - The first non-zero status encountered is preserved and returned
#     as the final exit code.
#
# Notes:
#   - Plugins must be readable (`-r`) to be loaded.
#   - This script does not stop on plugin failure; it only reports it.
#
# Exit / Return codes convention:
#   0 - Success
#   1 - Command failure or resource missing (remote, database, etc.)
#   2 - Network unreachable
#   3 - Local prerequisite missing (directory, config)

FAILED_STATUS=0  # keep first non-zero plugin status

# Load a specific plugin by name
load_plugin() {
    while [ "$#" -gt 0 ]; do
        for PLUGIN in "$SCRIPT_HOME/lib/plugins/"*"$1"; do
            if [ -r "$PLUGIN" ] && [ -f "$PLUGIN" ]; then
                . "$PLUGIN"
                st=$?
                [ "$st" -ne 0 ] && {
                    echo "[WARN] plugin failed: $PLUGIN status=$st" >&2
                    [ "$FAILED_STATUS" -eq 0 ] && FAILED_STATUS=$st
                }
            fi
        done
        shift
    done
}

# Load plugins defined in the `PLUGINS` variable
load_plugins_by_config() {
    load_plugin $PLUGINS
}

# Load all available plugins
load_plugins_all() {
    for PLUGIN in "$SCRIPT_HOME/lib/plugins/"*; do
        if [ -r "$PLUGIN" ]; then
            . "$PLUGIN"
            st=$?
            [ "$st" -ne 0 ] && {
                echo "[WARN] plugin failed: $PLUGIN status=$st" >&2
                [ "$FAILED_STATUS" -eq 0 ] && FAILED_STATUS=$st
            }
        fi
    done
}

# Determine which plugins to load based on configuration
load_plugins() {
    if [ "$LOAD_PLUGINS_ALL" = "true" ]; then
        load_plugins_all
    else
        load_plugins_by_config
    fi
    return ${FAILED_STATUS:-0}
}

# Execute plugin loading
load_plugins
