#!/bin/sh
#
# 31_dump_postgresql - A script to dump the entire PostgreSQL database cluster and compress the dump.
#
# Required environment variables:
#   PGDUMP   : Directory where the dump files (SQL and compressed files) will be stored.
#              Example: /var/lib/postgresql/pg_dump
#   PG_USER  : PostgreSQL username.
#              Example: postgres
#
# Note:
#   - This script assumes that authentication is handled via ~/.pgpass

dump_postgresql() {
    printf "* Executing pg_dumpall on "
    date "+%Y/%m/%d %T"

    # Remove existing compressed dump if it exists
    [ -f "$PGDUMP/all.dump.gz" ] && rm "$PGDUMP/all.dump.gz"

    # Perform the dump and compress the output
    pg_dumpall -c -U "$PG_USER" > "$PGDUMP/all.dump" \
      && gzip -f "$PGDUMP/all.dump"

    RC=$?
    echo "Return code is $RC"
}

printf "- [info] backup_postgresql has been loaded at "
date "+%Y/%m/%d %T"

dump_postgresql
